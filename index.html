<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Записи — Mobile</title>

<!-- Icons + Chart.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --primary: #007AFF;
  --secondary: #5856D6;
  --success: #34C759;
  --danger: #FF3B30;
  --warning: #FF9500;
  --bg: #070814;
  --surface: rgba(255,255,255,0.06);
  --surface-2: rgba(255,255,255,0.03);
  --text: #ffffff;
  --muted: rgba(255,255,255,0.68);
  --radius: 14px;
  --glass-blur: 14px;
}

/* Basic reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}

/* Background glow */
.bg {
  position:fixed; inset:0; z-index:-2;
  background:
    radial-gradient(circle at 15% 85%, rgba(88,86,214,0.12) 0%, transparent 30%),
    radial-gradient(circle at 85% 12%, rgba(255,149,0,0.08) 0%, transparent 30%),
    linear-gradient(180deg,#05060a,#081026 100%);
}

/* App container */
.app { display:flex; flex-direction:column; height:100vh; padding:12px; gap:12px; }

/* Header with totals */
.header {
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  padding:12px; border-radius:12px; background:linear-gradient(180deg,var(--surface),transparent);
  backdrop-filter: blur(var(--glass-blur)); border:1px solid rgba(255,255,255,0.04);
}
.totals { display:flex; gap:8px; align-items:center; }
.stat {
  background: rgba(255,255,255,0.02);
  padding:8px 10px; border-radius:12px; min-width:88px; text-align:center;
  border:1px solid rgba(255,255,255,0.03);
}
.stat .label { font-size:12px; color:var(--muted); }
.stat .value { font-weight:800; font-size:16px; margin-top:4px; }

/* Top-right small controls */
.ctrls { display:flex; gap:8px; align-items:center; }
.icon-btn { width:44px; height:44px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); font-size:18px; }

/* Main panels (mobile single column) */
.main { flex:1; overflow:auto; display:flex; flex-direction:column; gap:12px; padding-bottom:120px; }

/* Calendar card */
.card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:16px; padding:12px; border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(8px); }
.calendar-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.month-name { font-weight:900; font-size:18px; }
.month-nav { display:flex; gap:8px; align-items:center; }
.nav-btn { width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.04); background:transparent; font-size:16px; }

/* weekdays */
.weekdays { display:grid; grid-template-columns: repeat(7,1fr); gap:6px; margin-bottom:8px; }
.weekdays div { font-size:11px; color:var(--muted); text-align:center;}

/* days grid */
.days { display:grid; grid-template-columns: repeat(7,1fr); gap:6px; }
.day {
  aspect-ratio: 1/1;
  border-radius:10px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  font-weight:800; position:relative; transition: transform .15s ease;
  background:transparent; color:var(--text);
}
.day.other { color: rgba(255,255,255,0.18); opacity:0.8; }
.day:hover { transform: translateY(-4px); }
.day.today { background: linear-gradient(135deg,var(--warning), #FFB86B); color:#07122b; box-shadow:0 10px 28px rgba(255,149,0,0.12); }
.day.selected { outline:2px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); }
.day .dot { width:8px; height:8px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--secondary)); position:absolute; bottom:6px; }

/* small day-sum badge */
.day .day-sum {
  position:absolute; top:6px; right:6px; background: rgba(0,0,0,0.35);
  padding:4px 6px; border-radius:8px; font-size:11px; font-weight:800; color:var(--text);
  border:1px solid rgba(255,255,255,0.03);
}

/* tasks area */
.tasks { display:flex; flex-direction:column; gap:12px; margin-top:10px; }
.task-card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
  border-radius:14px; padding:12px; border:1px solid rgba(255,255,255,0.04);
  box-shadow: 0 12px 36px rgba(0,0,0,0.45); transition: transform .18s;
}
.task-card:hover { transform: translateY(-6px); }
.task-top { display:flex; justify-content:space-between; align-items:center; gap:8px; }
.client { font-weight:900; font-size:16px; }
.car { color:var(--muted); font-weight:700; margin-top:6px; font-size:13px; }
.task-meta { display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap; }
.detail { padding:8px 10px; border-radius:10px; background: rgba(255,255,255,0.02); color:var(--muted); font-weight:700; font-size:13px; }

/* price tag style exactly like first variant */
.price-row { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; }
.price-tag { padding:10px 14px; border-radius:12px; font-weight:900; font-size:16px; color:white; box-shadow: 0 8px 28px rgba(0,0,0,0.5); transition: all .25s; }
.price-tag.done { background: linear-gradient(135deg, #34C759, #2EBF54); box-shadow:0 8px 28px rgba(52,199,89,0.12); color:#07122b; }
.price-tag.pending { background: linear-gradient(135deg, #FFB86B, #FF8A3D); color:#07122b; box-shadow:0 8px 28px rgba(255,149,0,0.08); }
.price-tag.cancelled { background: linear-gradient(135deg, #B0B0B0, #8B8B8B); color:#07122b; opacity:0.95; }

/* actions */
.actions { display:flex; gap:8px; align-items:center; }
.action-btn { width:46px; height:46px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); display:flex; align-items:center; justify-content:center; background:transparent; color:var(--text); font-size:16px; }

/* chart small height so it doesn't push screen */
.chart-card { margin-top:6px; border-radius:12px; padding:10px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); }
.chart-canvas { height:140px; width:100%; }

/* bottom tab (keeps UI reachable) */
.bottom-nav { position:fixed; left:12px; right:12px; bottom:12px; height:64px; border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); display:flex; align-items:center; justify-content:space-around; border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(6px); }
/* add button */
.fab { position:fixed; right:26px; bottom:96px; width:64px; height:64px; border-radius:50%; background: linear-gradient(135deg,var(--primary),var(--secondary)); display:flex; align-items:center; justify-content:center; font-size:30px; color:white; box-shadow:0 18px 48px rgba(0,0,0,0.45); }

/* modal add/edit */
.modal-wrap { position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; z-index:60; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)); padding:12px; }
.modal { width:100%; max-width:520px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:16px; padding:12px; border:1px solid rgba(255,255,255,0.04); }
.input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); margin-top:8px; font-weight:700; }

/* small helpers */
.center { text-align:center; color:var(--muted); padding:14px; font-weight:800; }

@media (min-width:520px){ .app { max-width:420px; margin:0 auto; } .fab{ right:36px; bottom:96px; } }

</style>
</head>
<body>
  <div class="bg"></div>

  <div class="app" id="app">
    <!-- Header -->
    <div class="header">
      <div class="totals">
        <div class="stat">
          <div class="label">Всего</div>
          <div id="totalAll" class="value">0 ₽</div>
        </div>
        <div class="stat">
          <div class="label">Месяц</div>
          <div id="totalMonth" class="value">0 ₽</div>
        </div>
        <div class="stat">
          <div class="label">Сегодня</div>
          <div id="totalToday" class="value">0 ₽</div>
        </div>
      </div>
      <div class="ctrls">
        <button class="icon-btn" id="toggleChartMode" title="Переключить график"><i class="fas fa-chart-line"></i></button>
      </div>
    </div>

    <!-- Main -->
    <div class="main">
      <!-- Calendar Card -->
      <div class="card" id="calendarCard">
        <div class="calendar-head">
          <div class="month-name" id="monthLabel">Июнь 2025</div>
          <div class="month-nav">
            <button class="nav-btn" id="prevMonth"><i class="fas fa-chevron-left"></i></button>
            <button class="nav-btn" id="nextMonth"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>

        <div class="weekdays" id="weekdays"></div>
        <div class="days" id="daysGrid"></div>

        <!-- Chart small -->
        <div class="chart-card" style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="font-weight:900">Доход (выполнено)</div>
            <div style="color:var(--muted); font-weight:800; font-size:12px;" id="chartRangeLabel">30 дней</div>
          </div>
          <canvas id="incomeChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- Tasks card -->
      <div class="card" id="tasksCard">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:900">Записи</div>
          <div style="color:var(--muted); font-weight:800; font-size:13px" id="selectedDateLabel">—</div>
        </div>

        <div class="tasks" id="tasksList">
          <div class="center">Выберите дату в календаре, чтобы просмотреть записи</div>
        </div>
      </div>
    </div>

    <!-- Floating Add -->
    <div class="fab" id="openAdd" title="Добавить">＋</div>

    <!-- bottom nav placeholder to keep space -->
    <div class="bottom-nav" style="pointer-events:none;">
      <div style="width:44px"></div>
      <div style="width:44px"></div>
      <div style="width:44px"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-wrap" id="modalWrap">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div id="modalTitle" style="font-weight:900">Новая запись</div>
        <button class="icon-btn" id="closeModal"><i class="fas fa-times"></i></button>
      </div>

      <input id="mDate" type="date" class="input" style="display:none" />
      <input id="mClient" class="input" placeholder="Клиент" />
      <input id="mCar" class="input" placeholder="Авто" />
      <div style="display:flex;gap:8px;margin-top:8px;">
        <input id="mTime" class="input" placeholder="12:00" style="flex:1" />
        <input id="mPrice" class="input" placeholder="₽" style="width:110px" inputmode="numeric" />
      </div>
      <input id="mPlace" class="input" placeholder="Место" style="margin-top:8px" />
      <textarea id="mDesc" class="input" placeholder="Описание" rows="3" style="margin-top:8px"></textarea>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
        <button class="icon-btn" id="deleteBtn" title="Удалить" style="display:none;color:var(--danger)"><i class="fas fa-trash"></i></button>
        <button class="icon-btn" id="cancelBtn"><i class="fas fa-times-circle"></i></button>
        <button class="icon-btn" id="saveBtn" style="background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white;"><i class="fas fa-save"></i></button>
      </div>
    </div>
  </div>

<script>
/* Mobile calendar app script */
(function(){
  // Utilities
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const fmtMoney = n => (parseInt(n)||0).toLocaleString() + ' ₽';
  const todayISO = () => new Date().toISOString().slice(0,10);
  const monthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
  const weekdays = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];

  // Elements
  const totalAllEl = $('#totalAll');
  const totalMonthEl = $('#totalMonth');
  const totalTodayEl = $('#totalToday');
  const monthLabel = $('#monthLabel');
  const weekdaysEl = $('#weekdays');
  const daysGrid = $('#daysGrid');
  const tasksList = $('#tasksList');
  const selectedDateLabel = $('#selectedDateLabel');
  const incomeCanvas = document.getElementById('incomeChart');
  const chartRangeLabel = $('#chartRangeLabel');

  const openAdd = $('#openAdd');
  const modalWrap = $('#modalWrap');
  const closeModal = $('#closeModal');
  const cancelBtn = $('#cancelBtn');
  const saveBtn = $('#saveBtn');
  const deleteBtn = $('#deleteBtn');

  const mDate = $('#mDate');
  const mClient = $('#mClient');
  const mCar = $('#mCar');
  const mTime = $('#mTime');
  const mPrice = $('#mPrice');
  const mPlace = $('#mPlace');
  const mDesc = $('#mDesc');

  const prevMonthBtn = $('#prevMonth');
  const nextMonthBtn = $('#nextMonth');
  const toggleChartModeBtn = $('#toggleChartMode');

  // State
  let tasks = JSON.parse(localStorage.getItem('mobile_tasks') || '{}'); // { 'YYYY-MM-DD': [{client,car,time,price,place,desc,done,createdAt}] }
  let view = new Date();
  let selectedDate = todayISO();
  let chartMode = 'daily'; // daily / monthly

  // Chart
  let incomeChart = null;

  // Init
  function init(){
    renderWeekdays();
    renderCalendar();
    renderTasks();
    updateTotals();
    initChart();
    bind();
    // if empty, prompt to add demo data quickly
    if (Object.keys(tasks).length === 0) {
      // add sample quickly (non-blocking)
      setTimeout(()=> {
        if (confirm('Добавить демонстрационные данные для просмотра интерфейса?')) {
          addSampleData();
        }
      }, 600);
    }
  }

  function bind(){
    prevMonthBtn.addEventListener('click', ()=>{ changeMonth(-1); });
    nextMonthBtn.addEventListener('click', ()=>{ changeMonth(1); });
    openAdd.addEventListener('click', ()=> openModalFor(selectedDate));
    closeModal.addEventListener('click', closeModalWrap);
    cancelBtn.addEventListener('click', closeModalWrap);
    saveBtn.addEventListener('click', saveFromModal);
    deleteBtn.addEventListener('click', deleteFromModal);
    // swipe for month
    addSwipe(daysGrid, (dir)=> changeMonth(dir));
    // toggle chart mode
    toggleChartModeBtn.addEventListener('click', ()=> {
      chartMode = chartMode === 'daily' ? 'monthly' : 'daily';
      updateChart();
      chartRangeLabel.textContent = chartMode === 'daily' ? '30 дней' : '12 мес.';
    });
  }

  function addSwipe(el, callback){
    let startX = null;
    el.addEventListener('touchstart', (e)=> { startX = e.touches[0].clientX; }, {passive:true});
    el.addEventListener('touchend', (e)=> {
      if (startX===null) return;
      const dx = e.changedTouches[0].clientX - startX;
      if (Math.abs(dx) > 40) callback(dx < 0 ? 1 : -1);
      startX = null;
    });
  }

  // Rendering utilities
  function renderWeekdays(){
    weekdaysEl.innerHTML = weekdays.map(d => `<div>${d}</div>`).join('');
  }

  function renderCalendar(){
    const y = view.getFullYear();
    const m = view.getMonth();
    monthLabel.textContent = monthNames[m] + ' ' + y;

    daysGrid.innerHTML = '';
    const first = new Date(y,m,1);
    const last = new Date(y,m+1,0);
    const pad = (first.getDay() === 0) ? 6 : first.getDay() - 1; // Mon-first mapping
    // blanks
    for (let i=0;i<pad;i++){
      const el = document.createElement('div');
      el.className = 'day other';
      daysGrid.appendChild(el);
    }
    const today = todayISO();
    for (let d=1; d<=last.getDate(); d++){
      const dateObj = new Date(y,m,d);
      const ds = dateObj.toISOString().slice(0,10);
      const el = document.createElement('div');
      el.className = 'day';
      if (ds === today) el.classList.add('today');
      if (ds === selectedDate) el.classList.add('selected');
      if ((tasks[ds]||[]).length) el.classList.add('has');
      el.dataset.date = ds;
      el.innerHTML = `<div style="z-index:1">${d}</div>`;
      // day-sum if exists
      const sum = calcDaySum(ds);
      if (sum > 0) {
        const sumBadge = document.createElement('div');
        sumBadge.className = 'day-sum';
        sumBadge.textContent = sum.toLocaleString() + ' ₽';
        el.appendChild(sumBadge);
      }
      if ((tasks[ds]||[]).length) {
        const dot = document.createElement('div');
        dot.className = 'dot'; el.appendChild(dot);
      }
      el.addEventListener('click', ()=> {
        selectedDate = ds;
        renderCalendar();
        renderTasks();
      });
      daysGrid.appendChild(el);
    }
    // set selected Date label
    updateSelectedDateLabel();
  }

  function renderTasks(){
    const list = tasks[selectedDate] || [];
    $('#selectedDateLabel').textContent = formatSelectedDate(selectedDate);
    if (!list.length){
      tasksList.innerHTML = `<div class="center">Нет записей на ${formatSelectedDate(selectedDate)}</div>`;
      return;
    }
    tasksList.innerHTML = '';
    list.forEach((t, idx) => {
      const card = document.createElement('div');
      card.className = 'task-card';
      card.innerHTML = `
        <div class="task-top">
          <div>
            <div class="client">${escapeHtml(t.client||'Без имени')}</div>
            <div class="car">${escapeHtml(t.car||'—')}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;">
            <div style="font-weight:900" class="time-pill">${escapeHtml(t.time||'—')}</div>
            <div style="color:var(--muted); font-size:12px; margin-top:8px">${escapeHtml(t.place||'—')}</div>
          </div>
        </div>
        <div class="price-row">
          <div class="price-tag ${t.done ? 'done' : 'pending'}">${fmtMoney(t.price)}</div>
          <div class="actions">
            <button class="action-btn" data-act="toggle" data-i="${idx}" title="${t.done ? 'Отметить как не выполнено' : 'Отметить выполнено'}"><i class="fas ${t.done ? 'fa-check' : 'fa-circle'}"></i></button>
            <button class="action-btn" data-act="edit" data-i="${idx}" title="Редактировать"><i class="fas fa-edit"></i></button>
            <button class="action-btn" data-act="del" data-i="${idx}" title="Удалить"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `;
      // event delegation via container
      tasksList.appendChild(card);
    });
  }

  // Helpers
  function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function formatSelectedDate(d){
    if (!d) return '—';
    const dt = new Date(d);
    const today = new Date(); if (d === todayISO()) return 'Сегодня';
    return dt.toLocaleDateString('ru-RU', { weekday:'long', day:'numeric', month:'long' });
  }

  function calcDaySum(date){
    const arr = tasks[date] || [];
    return arr.reduce((s,t)=> s + (parseInt(t.price) || 0), 0);
  }

  function updateSelectedDateLabel(){
    $('#selectedDateLabel').textContent = formatSelectedDate(selectedDate);
  }

  // Totals
  function updateTotals(){
    let totalAll = 0, totalMonth = 0, totalToday = 0;
    const today = todayISO();
    const monthPrefix = `${view.getFullYear()}-${String(view.getMonth()+1).padStart(2,'0')}`;
    for (const date in tasks){
      for (const t of tasks[date]){
        const p = parseInt(t.price) || 0;
        if (t.done) totalAll += p; // count only done as earned
        if (date.slice(0,7) === monthPrefix && t.done) totalMonth += p;
        if (date === today && t.done) totalToday += p;
      }
    }
    totalAllEl.textContent = fmtMoney(totalAll);
    totalMonthEl.textContent = fmtMoney(totalMonth);
    totalTodayEl.textContent = fmtMoney(totalToday);
  }

  // Month change
  function changeMonth(delta){
    view.setMonth(view.getMonth() + delta);
    renderCalendar();
    // update monthly totals based on new month
    updateTotals();
    updateChart();
  }

  // Modal handling
  function openModalFor(date, editIndex=null){
    modalWrap.style.display = 'flex';
    mDate.value = date || selectedDate;
    mClient.value = ''; mCar.value = ''; mTime.value = ''; mPrice.value = ''; mPlace.value = ''; mDesc.value = '';
    if (editIndex !== null){
      const t = (tasks[date]||[])[editIndex];
      if (t){ mClient.value = t.client || ''; mCar.value = t.car || ''; mTime.value = t.time || ''; mPrice.value = t.price || ''; mPlace.value = t.place || ''; mDesc.value = t.desc || ''; deleteBtn.style.display = ''; modalWrap.dataset.edit = editIndex; } 
    } else { deleteBtn.style.display = 'none'; modalWrap.dataset.edit = ''; }
  }
  function closeModalWrap(){ modalWrap.style.display = 'none'; modalWrap.dataset.edit = ''; }
  function saveFromModal(){
    const date = mDate.value || selectedDate;
    if (!tasks[date]) tasks[date] = [];
    const obj = { client: mClient.value.trim(), car: mCar.value.trim(), time: mTime.value.trim(), price: mPrice.value.trim(), place: mPlace.value.trim(), desc: mDesc.value.trim(), done:false, createdAt: new Date().toISOString() };
    const edit = modalWrap.dataset.edit;
    if (edit !== '') {
      tasks[date][Number(edit)] = obj;
    } else {
      tasks[date].push(obj);
    }
    persist();
    renderCalendar();
    renderTasks();
    updateTotals();
    updateChart();
    closeModalWrap();
  }
  function deleteFromModal(){
    const date = mDate.value || selectedDate;
    const edit = modalWrap.dataset.edit;
    if (edit === '') return;
    if (!confirm('Удалить запись?')) return;
    tasks[date].splice(Number(edit),1);
    if (!tasks[date].length) delete tasks[date];
    persist();
    renderCalendar();
    renderTasks();
    updateTotals();
    updateChart();
    closeModalWrap();
  }

  // Task list actions (delegate)
  tasksList.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-act]');
    if (!btn) return;
    const act = btn.dataset.act;
    const idx = Number(btn.dataset.i);
    const date = selectedDate;
    if (act === 'toggle'){
      tasks[date][idx].done = !tasks[date][idx].done;
      persist();
      renderTasks();
      updateTotals();
      updateChart();
    } else if (act === 'edit'){
      openModalFor(date, idx);
    } else if (act === 'del'){
      if (!confirm('Удалить запись?')) return;
      tasks[date].splice(idx,1);
      if (!tasks[date].length) delete tasks[date];
      persist();
      renderCalendar();
      renderTasks();
      updateTotals();
      updateChart();
    }
  });

  // Persistence
  function persist(){ localStorage.setItem('mobile_tasks', JSON.stringify(tasks)); }

  // Demo data
  function addSampleData(){
    const today = new Date();
    const tom = new Date(); tom.setDate(tom.getDate()+1);
    const a = {};
    a[today.toISOString().slice(0,10)] = [
      { client:'Иван Петров', car:'BMW X5', time:'10:00', price:'5000', place:'Сервис Ленина', desc:'Замена масла', done:true, createdAt:new Date().toISOString() },
      { client:'Анна Сидорова', car:'Mercedes C', time:'14:30', price:'3200', place:'Мойка Премиум', desc:'Химчистка', done:false, createdAt:new Date().toISOString() }
    ];
    a[tom.toISOString().slice(0,10)] = [
      { client:'Пётр Иванов', car:'Audi A6', time:'11:00', price:'7500', place:'Шиномонтаж', desc:'Шины', done:false, createdAt:new Date().toISOString() }
    ];
    tasks = {...a, ...tasks};
    persist();
    renderCalendar(); renderTasks(); updateTotals(); updateChart();
  }

  // Chart
  function initChart(){
    const ctx = incomeCanvas.getContext('2d');
    incomeChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label:'Доход', data: [], fill:true, tension:0.36, pointRadius:3 }] },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins: { legend:{ display:false }, tooltip:{ mode:'index', intersect:false } },
        scales: {
          x: { ticks:{ color:'#cfd8ff' }, grid:{ display:false } },
          y: { ticks:{ color:'#cfd8ff' }, grid:{ color:'rgba(255,255,255,0.03)' } }
        }
      }
    });
    updateChart();
  }

  function updateChart(){
    if (!incomeChart) return;
    if (chartMode === 'daily'){
      const labels=[]; const data=[];
      for (let i=29;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate()-i);
        const ds = d.toISOString().slice(0,10);
        labels.push(d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'}));
        let s=0; (tasks[ds]||[]).forEach(t=> { if (t.done) s += Number(t.price || 0); });
        data.push(s);
      }
      incomeChart.data.labels = labels;
      incomeChart.data.datasets[0].data = data;
      incomeChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#007AFF';
      incomeChart.data.datasets[0].backgroundColor = createGradient(incomeChart.ctx, incomeChart.canvas.height, false);
    } else {
      // monthly last 12 months
      const labels=[]; const data=[];
      const now = new Date();
      for (let i=11;i>=0;i--){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const key = d.toISOString().slice(0,7); // YYYY-MM
        labels.push(d.toLocaleDateString('ru-RU',{month:'short', year:'numeric'}));
        let s = 0;
        for (const date in tasks){
          if (date.slice(0,7) === key) (tasks[date]||[]).forEach(t=> { if (t.done) s += Number(t.price || 0); });
        }
        data.push(s);
      }
      incomeChart.data.labels = labels;
      incomeChart.data.datasets[0].data = data;
      incomeChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary') || '#5856D6';
      incomeChart.data.datasets[0].backgroundColor = createGradient(incomeChart.ctx, incomeChart.canvas.height, true);
    }
    incomeChart.update();
  }

  function createGradient(ctx, height, inverted){
    const g = ctx.createLinearGradient(0,0,0,height);
    if (!inverted){
      g.addColorStop(0, 'rgba(0,122,255,0.32)');
      g.addColorStop(1, 'rgba(52,199,89,0.04)');
    } else {
      g.addColorStop(0, 'rgba(88,86,214,0.28)');
      g.addColorStop(1, 'rgba(88,86,214,0.04)');
    }
    return g;
  }

  // small utilities: calculate totals for header with current view month
  function recalcTotals(){
    // All-time, month-of-view, today
    let all = 0, month = 0, today = 0;
    const todayStr = todayISO();
    const mPref = `${view.getFullYear()}-${String(view.getMonth()+1).padStart(2,'0')}`;
    for (const date in tasks){
      for (const t of tasks[date]){
        const p = Number(t.price || 0);
        if (t.done) all += p;
        if (date.slice(0,7) === mPref && t.done) month += p;
        if (date === todayStr && t.done) today += p;
      }
    }
    totalAllEl.textContent = fmtMoney(all);
    totalMonthEl.textContent = fmtMoney(month);
    totalTodayEl.textContent = fmtMoney(today);
  }

  // helper to update totals & UI
  function updateTotals(){
    recalcTotals();
    // keep calendar day-sums updated
    // (we already render day sums on renderCalendar)
  }

  // Persist & load
  function persist(){ localStorage.setItem('mobile_tasks', JSON.stringify(tasks)); }

  // change view when selecting different month/day
  window.addEventListener('storage', ()=> {
    try { tasks = JSON.parse(localStorage.getItem('mobile_tasks')||'{}'); renderCalendar(); renderTasks(); updateTotals(); updateChart(); } catch(e){}
  });

  // init run
  init();

  // small helpers accessible from console if needed
  window.mobileApp = {
    addSampleData,
    tasks,
    persist,
    renderCalendar,
    renderTasks,
    updateChart,
    openModalFor
  };

  // expose some actions for quick testing via UI
  // when clicking prev/next month nav -> already attached
  // When clicking empty day -> open add modal (already clickable)
  // implement: clicking day opens list; double-tap task toggles done
  tasksList.addEventListener('dblclick', (ev) => {
    const card = ev.target.closest('.task-card');
    if (!card) return;
    const idx = Array.from(tasksList.children).indexOf(card);
    if (idx >= 0) {
      const d = selectedDate;
      tasks[d][idx].done = !tasks[d][idx].done;
      persist(); renderTasks(); updateTotals(); updateChart();
    }
  });

})();
</script>
</body>
</html>
