<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Mobile Calendar ‚Äî updated</title>
<!-- Chart.js for chart rendering -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg:#0b0d16;
  --glass:rgba(255,255,255,0.06);
  --blur:20px;
  --radius:18px;
  --text:#fff;
  --accent:#4a6cfa;
  --accent2:#9a4aff;
}
/* lock body scroll; only tasks list and modal scroll */
html,body{margin:0;background:var(--bg);font-family:system-ui;color:var(--text);height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}
.container{display:flex;flex-direction:column;height:100vh;padding:0 12px 12px 12px}

/* Header */
.header{padding:12px 8px;background:var(--glass);backdrop-filter:blur(var(--blur));display:flex;justify-content:center;align-items:center;font-size:20px;font-weight:800;position:relative;border-radius:12px;margin-top:12px}

/* Unified toggle button (moved left a bit) */
.toggle-btn{position:absolute;right:34px;top:10px;width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;justify-content:center;align-items:center;font-size:18px;box-shadow:0 8px 18px rgba(0,0,0,0.35);border:none}
.toggle-btn:active{transform:scale(0.96);} 

/* Views */
.view{flex:1;padding:12px 8px 0 8px;display:none}
.view.active{display:block}

/* Calendar */
.month-switch{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.switch-arrow{width:40px;height:40px;border-radius:12px;background:var(--glass);backdrop-filter:blur(var(--blur));display:flex;justify-content:center;align-items:center;font-size:18px;border:none}
.month-name{font-size:18px;font-weight:800}

.days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{aspect-ratio:1/1;display:flex;justify-content:center;align-items:center;border-radius:12px;background:transparent;position:relative;font-weight:700;cursor:pointer;padding:6px}
.day.other{color:rgba(255,255,255,0.18)}
.day.today{background:linear-gradient(135deg,var(--accent2),var(--accent));color:#07122b;border-radius:12px}
.day.selected{box-shadow:0 8px 20px rgba(74,108,250,0.12);background:rgba(255,255,255,0.02)}
.day .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));position:absolute;bottom:6px;border:1px solid rgba(255,255,255,0.08)}

/* Tasks area - scrollable only here */
.tasks-wrap{margin-top:12px}
#tasksList{overflow:auto;-webkit-overflow-scrolling:touch;padding-right:6px}
.task-card{background:var(--glass);backdrop-filter:blur(var(--blur));padding:12px;border-radius:14px;margin-bottom:10px}
.client-name{font-size:16px;font-weight:800}
.meta{font-size:13px;color:rgba(255,255,255,0.7);margin-top:6px}
.price{margin-top:8px;padding:8px;border-radius:10px;font-weight:800;text-align:center;background:#111}

/* Chart view */
.chart-wrap{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.chart-box{flex:1;background:var(--glass);backdrop-filter:blur(var(--blur));border-radius:14px;padding:10px}
.canvas{width:100%;height:160px}
.stats-box{width:120px;text-align:center}
.modem-counter{font-weight:900;font-size:18px;margin-top:8px}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:none;justify-content:center;align-items:flex-end;z-index:60}
.modal{width:100%;max-width:520px;background:var(--glass);backdrop-filter:blur(var(--blur));padding:14px;border-radius:14px;margin:12px}
.input{width:100%;margin-bottom:8px;padding:10px;border-radius:10px;background:#111;border:none;color:white;font-weight:800}
.row{display:flex;gap:8px}
.btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:12px;text-align:center;font-weight:800;margin-top:8px;color:#07122b;border:none}
.small{font-size:13px;color:rgba(255,255,255,0.7)}

.center{ text-align:center;color:rgba(255,255,255,0.6);padding:14px;font-weight:800}

</style>
</head>
<body>
<div class="container">
  <div class="header">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    <button id="toggle" class="toggle-btn" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥">üìÖ</button>
  </div>

  <!-- Calendar view -->
  <div id="calendar-view" class="view active">
    <div class="month-switch">
      <button id="prevMonth" class="switch-arrow">‚ùÆ</button>
      <div class="month-name" id="monthName">–ò—é–Ω—å 2025</div>
      <button id="nextMonth" class="switch-arrow">‚ùØ</button>
    </div>

    <div class="days-grid" id="daysGrid"></div>

    <div class="tasks-wrap">
      <div id="tasksList"><div class="center">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–ø–∏—Å–∏</div></div>
    </div>
  </div>

  <!-- Chart / Stats view -->
  <div id="chart-view" class="view">
    <div class="chart-wrap">
      <div class="chart-box">
        <div style="font-weight:800;margin-bottom:8px">–î–æ—Ö–æ–¥ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)</div>
        <canvas id="incomeChart" class="canvas"></canvas>
      </div>
      <div class="stats-box">
        <div style="font-weight:800">–ê–¥—Ä–µ—Å–∞</div>
        <canvas id="statsChart" width="120" height="120"></canvas>
        <div class="modem-counter" id="modemCounter">0/0</div>
        <div class="small">–ü—Ä–æ–¥–∞–Ω–æ –º–æ–¥–µ–º–æ–≤ / –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
      </div>
    </div>

    <div style="margin-top:8px;background:var(--glass);backdrop-filter:blur(var(--blur));padding:12px;border-radius:12px">
      <div style="font-weight:800;margin-bottom:6px">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–¥—Ä–µ—Å–æ–≤ (–≤ %)</div>
      <div id="addrPercents" class="small">‚Äî</div>
    </div>
  </div>

</div>

<!-- Modal for adding/editing -->
<div class="modal-bg" id="modalBg">
  <div class="modal" id="modal">
    <div style="font-weight:900;margin-bottom:6px">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div>
    <input class="input" id="clientName" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" />
    <input class="input" id="carModel" placeholder="–ú–∞—à–∏–Ω–∞" />
    <div class="row">
      <input class="input" id="time" placeholder="–í—Ä–µ–º—è (HH:MM)" style="flex:1" />
      <input class="input" id="price" placeholder="–¶–µ–Ω–∞" style="width:110px" inputmode="numeric" />
    </div>
    <select class="input" id="addrType">
      <option value="home">–î–æ–º</option>
      <option value="online">–û–Ω–ª–∞–π–Ω</option>
      <option value="other">–î—Ä—É–≥–æ–µ</option>
    </select>
    <label style="display:flex;align-items:center;gap:8px;margin-top:6px"><input type="checkbox" id="modemSold"> <span class="small">–ü—Ä–æ–¥–∞–Ω –º–æ–¥–µ–º</span></label>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="saveRecord">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn" id="cancelRecord" style="background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.06);">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
// --- Data model ---
const STORAGE_KEY = 'mobile_tasks_v2';
// tasks: { 'YYYY-MM-DD': [ {client, car, time, price, addrType, modemSold:boolean, done:boolean, createdAt} ] }
let tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
let view = new Date();
let selectedDate = new Date().toISOString().slice(0,10); // YYYY-MM-DD (fix timezone issues)
let onCalendar = true;

// DOM
const toggleBtn = document.getElementById('toggle');
const calView = document.getElementById('calendar-view');
const chartView = document.getElementById('chart-view');
const daysGrid = document.getElementById('daysGrid');
const monthName = document.getElementById('monthName');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');
const tasksList = document.getElementById('tasksList');
const modalBg = document.getElementById('modalBg');
const clientName = document.getElementById('clientName');
const carModel = document.getElementById('carModel');
const timeInput = document.getElementById('time');
const priceInput = document.getElementById('price');
const addrType = document.getElementById('addrType');
const modemSold = document.getElementById('modemSold');
const saveRecordBtn = document.getElementById('saveRecord');
const cancelRecordBtn = document.getElementById('cancelRecord');
const incomeCtx = document.getElementById('incomeChart').getContext('2d');
const statsCtx = document.getElementById('statsChart').getContext('2d');
const modemCounterEl = document.getElementById('modemCounter');
const addrPercents = document.getElementById('addrPercents');

let incomeChart = null;
let statsChart = null;

// --- Helpers ---
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>'\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function formatMonthYear(d){ return d.toLocaleString('ru', { month:'long', year:'numeric' }); }

// --- Calendar rendering (fixed timezone issue by using toISOString date strings) ---
function renderCalendar(){
  daysGrid.innerHTML = '';
  const y = view.getFullYear(); const m = view.getMonth();
  const first = new Date(y,m,1);
  const daysInMonth = new Date(y,m+1,0).getDate();
  monthName.textContent = formatMonthYear(first);

  // pad with empty boxes for weekdays (Mon-first)
  const startWeekday = (first.getDay() + 6) % 7; // 0..6 where 0=Mon
  for(let i=0;i<startWeekday;i++){ const empty = document.createElement('div'); empty.className='day other'; daysGrid.appendChild(empty); }

  for(let d=1; d<=daysInMonth; d++){
    const dateObj = new Date(Date.UTC(y,m,d)); // use UTC to avoid TZ shift
    const iso = dateObj.toISOString().slice(0,10);
    const el = document.createElement('div'); el.className='day'; el.dataset.date = iso;

    // day number
    const num = document.createElement('div'); num.textContent = d; num.style.zIndex='1'; el.appendChild(num);

    // marker if records exist
    if((tasks[iso]||[]).length){ const dot = document.createElement('div'); dot.className='dot'; el.appendChild(dot); }

    // today
    const today = new Date().toISOString().slice(0,10);
    if(iso === today) el.classList.add('today');
    if(iso === selectedDate) el.classList.add('selected');

    el.addEventListener('click', ()=>{ selectedDate = iso; renderCalendar(); renderTasks(); });
    daysGrid.appendChild(el);
  }
}

// --- Tasks rendering ---
function renderTasks(){
  const list = tasks[selectedDate] || [];
  tasksList.innerHTML = '';
  if(!list.length){ tasksList.innerHTML = `<div class="center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ ${selectedDate}</div>`; return; }

  list.forEach((t,i)=>{
    const card = document.createElement('div'); card.className='task-card';
    card.innerHTML = `
      <div class="client-name">${escapeHtml(t.client)}</div>
      <div class="meta">${escapeHtml(t.car)} ‚Ä¢ ${escapeHtml(t.time)} ‚Ä¢ ${t.addrType || '‚Äî'}</div>
      <div class="price">${Number(t.price||0).toLocaleString()} ‚ÇΩ ${t.modemSold? '<span style="margin-left:8px;color:#9af">[–ú–æ–¥–µ–º]</span>':''}</div>
    `;
    const del = document.createElement('div'); del.style.textAlign='right'; del.style.marginTop='8px';
    del.innerHTML = `<button style="padding:8px 10px;border-radius:10px;border:0;background:rgba(255,255,255,0.04);color:#fff;">–£–¥–∞–ª–∏—Ç—å</button>`;
    del.querySelector('button').addEventListener('click', ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')){ tasks[selectedDate].splice(i,1); if(!tasks[selectedDate].length) delete tasks[selectedDate]; persist(); renderCalendar(); renderTasks(); updateAllCharts(); } });
    card.appendChild(del);
    tasksList.appendChild(card);
  });
}

// --- Income chart (line) and stats chart (doughnut) ---
function initCharts(){
  incomeChart = new Chart(incomeCtx, { type:'line', data:{ labels:[], datasets:[{ label:'–î–æ—Ö–æ–¥', data:[], fill:true, backgroundColor:'rgba(74,108,250,0.14)', borderColor:'#4a6cfa', tension:0.35 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } });

  statsChart = new Chart(statsCtx, { type:'doughnut', data:{ labels:['–î–æ–º','–û–Ω–ª–∞–π–Ω','–î—Ä—É–≥–æ–µ'], datasets:[{ data:[0,0,0], backgroundColor:['#4a6cfa','#9a4aff','#34c759'] }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom',labels:{boxWidth:8}}} } });
}

function updateIncomeChart(){
  if(!incomeChart) initCharts();
  const labels=[]; const data=[];
  for(let i=29;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const iso = d.toISOString().slice(0,10); labels.push(d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'})); let s=0; (tasks[iso]||[]).forEach(r=>{ s += Number(r.price||0); }); data.push(s); }
  incomeChart.data.labels = labels; incomeChart.data.datasets[0].data = data; incomeChart.update();
}

function updateStats(){
  // count address types and modem sales
  let home=0, online=0, other=0, modemSoldCount=0, totalOrders=0;
  for(const date in tasks){ for(const r of tasks[date]){ totalOrders++; const t = r.addrType || 'other'; if(t==='home') home++; else if(t==='online') online++; else other++; if(r.modemSold) modemSoldCount++; } }
  statsChart.data.datasets[0].data = [home, online, other]; statsChart.update();
  modemCounterEl.textContent = `${modemSoldCount}/${totalOrders}`;
  const total = home+online+other || 1;
  addrPercents.textContent = `–î–æ–º: ${Math.round(home/total*100)}% ‚Ä¢ –û–Ω–ª–∞–π–Ω: ${Math.round(online/total*100)}% ‚Ä¢ –î—Ä—É–≥–æ–µ: ${Math.round(other/total*100)}%`;
}

function updateAllCharts(){ updateIncomeChart(); updateStats(); }

// --- Modal handling ---
let editing = null; // {date, index} if editing
function openModal(date, index=null){
  editing = null;
  clientName.value=''; carModel.value=''; timeInput.value=''; priceInput.value=''; addrType.value='home'; modemSold.checked=false;
  if(index!==null){ const rec = (tasks[date]||[])[index]; if(rec){ clientName.value = rec.client||''; carModel.value = rec.car||''; timeInput.value = rec.time||''; priceInput.value = rec.price||''; addrType.value = rec.addrType||'other'; modemSold.checked = !!rec.modemSold; editing = {date, index}; } }
  modalBg.style.display = 'flex';
}
function closeModal(){ modalBg.style.display = 'none'; editing = null; }

saveRecordBtn.addEventListener('click', ()=>{
  const client = clientName.value.trim(); if(!client){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
  const car = carModel.value.trim(); const time = timeInput.value.trim(); const price = Number(priceInput.value.trim()) || 0; const at = addrType.value; const ms = modemSold.checked;
  const rec = { client, car, time, price, addrType:at, modemSold:ms, done:false, createdAt:new Date().toISOString() };
  const date = selectedDate;
  if(editing){ tasks[editing.date][editing.index] = rec; }
  else { if(!tasks[date]) tasks[date]=[]; tasks[date].push(rec); }
  persist(); renderCalendar(); renderTasks(); updateAllCharts(); scheduleNotificationFor(rec, date); closeModal();
});

cancelRecordBtn.addEventListener('click', closeModal);

// double-click on day to open modal
daysGrid.addEventListener('dblclick', e=>{ const d = e.target.closest('.day'); if(!d) return; selectedDate = d.dataset.date; renderCalendar(); renderTasks(); openModal(selectedDate); });

// prev/next
prevMonth.addEventListener('click', ()=>{ view.setMonth(view.getMonth()-1); renderCalendar(); });
nextMonth.addEventListener('click', ()=>{ view.setMonth(view.getMonth()+1); renderCalendar(); });

// toggle view
toggleBtn.addEventListener('click', ()=>{
  onCalendar = !onCalendar; calView.classList.toggle('active', onCalendar); chartView.classList.toggle('active', !onCalendar); toggleBtn.textContent = onCalendar? 'üìÖ' : 'üìä'; if(!onCalendar) updateAllCharts();
});

// --- Notifications (limitations explained) ---
// We'll register a Service Worker (inline via Blob) so the page can receive push events from a server.
// NOTE: To send push notifications at the right time ("–∑–∞ –¥–µ–Ω—å –¥–æ"), you need a server that keeps subscriptions
// and triggers a push message when needed (APNs/FCM/VAPID). Browsers cannot reliably schedule notifications when the page is closed.
// Below: register SW, offer subscription flow and a local fallback using setTimeout (works only while page is open).

let swRegistration = null;
async function registerInlineSW(){
  if(!('serviceWorker' in navigator)) return;
  const swCode = `self.addEventListener('push', function(e){
    let data = {};
    try{ data = e.data.json(); }catch(err){ data = {title:'–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ', body: e.data ? e.data.text() : '–£ –≤–∞—Å –∑–∞–ø–∏—Å—å'} }
    const title = data.title || '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ';
    const options = { body: data.body || '', tag: data.tag || 'reminder', data: data, renotify:true };
    self.registration.showNotification(title, options);
  });
  self.addEventListener('notificationclick', function(e){ e.notification.close(); if(e.notification.data && e.notification.data.url) clients.openWindow(e.notification.data.url); }, false);`;

  const blob = new Blob([swCode], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(blob);
  try{ swRegistration = await navigator.serviceWorker.register(swUrl); console.log('SW registered'); }catch(err){ console.warn('SW reg failed', err); }
}

// Convert VAPID key helper (placeholder)
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
  return outputArray;
}

async function subscribeForPush(){
  if(!('serviceWorker' in navigator) || !('PushManager' in window)) { alert('Push –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'); return; }
  if(!swRegistration) await registerInlineSW();
  const permission = await Notification.requestPermission();
  if(permission !== 'granted'){ alert('–ù—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'); return; }
  // You MUST replace VAPID_PUBLIC_KEY with your public VAPID key on the server
  const VAPID_PUBLIC_KEY = 'REPLACE_WITH_YOUR_VAPID_PUBLIC_KEY';
  try{
    const sub = await swRegistration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY) });
    // send `sub` to your server to store and send pushes later
    console.log('Subscribed', sub);
    // Example: await fetch('/subscribe', {method:'POST', body:JSON.stringify(sub), headers:{'Content-Type':'application/json'}});
    alert('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∑–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É push –∑–∞ –¥–µ–Ω—å –¥–æ –∑–∞–ø–∏—Å–∏.');
  }catch(e){ console.warn(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'); }
}

// Local fallback: schedule a notification using setTimeout (only works while page is open)
const localTimers = [];
function scheduleNotificationFor(rec, dateISO){
  // try to schedule for 24 hours before event time (if time provided)
  let eventTime = dateISO + 'T00:00:00';
  if(rec.time){ const t = rec.time.trim(); // expects HH:MM
    if(/^\d{1,2}:\d{2}$/.test(t)) eventTime = dateISO + 'T' + t + ':00';
  }
  const eventTs = new Date(eventTime).getTime();
  const notifyTs = eventTs - 24*60*60*1000; // 24h earlier
  const delay = notifyTs - Date.now();
  if(delay > 0 && delay < 30*24*60*60*1000){ // only schedule if within 30 days
    const id = setTimeout(async ()=>{
      // show notification via SW if available
      if(swRegistration){ swRegistration.showNotification('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏', { body: `–ó–∞–≤—Ç—Ä–∞: ${rec.client} ${rec.time || ''}`, data:{url: location.href} }); }
      else if ('Notification' in window && Notification.permission === 'granted'){ new Notification('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∑–∞–ø–∏—Å–∏', { body:`–ó–∞–≤—Ç—Ä–∞: ${rec.client} ${rec.time || ''}` }); }
    }, delay);
    localTimers.push(id);
  }
}

// --- Stats & charts init ---
function init(){ renderCalendar(); renderTasks(); initCharts(); updateAllCharts(); registerInlineSW(); adjustTasksHeight(); }
function initCharts(){ initCharts = function(){}; // once
  initCharts();
}

// avoid re-declaring Chart in initCharts above; implement actual init
function initCharts(){
  // incomeChart and statsChart initialised on first updateAllCharts call
}

function updateAllCharts(){
  // lazy init of charts
  if(!incomeChart){ incomeChart = new Chart(incomeCtx, { type:'line', data:{ labels:[], datasets:[{ label:'–î–æ—Ö–æ–¥', data:[], fill:true, backgroundColor:'rgba(74,108,250,0.14)', borderColor:'#4a6cfa', tension:0.35 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } }); }
  if(!statsChart){ statsChart = new Chart(statsCtx, { type:'doughnut', data:{ labels:['–î–æ–º','–û–Ω–ª–∞–π–Ω','–î—Ä—É–≥–æ–µ'], datasets:[{ data:[0,0,0], backgroundColor:['#4a6cfa','#9a4aff','#34c759'] }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } }); }
  updateIncomeChart(); updateStats();
}

function updateIncomeChart(){ const labels=[]; const data=[]; for(let i=29;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); const iso = d.toISOString().slice(0,10); labels.push(d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'})); let s=0; (tasks[iso]||[]).forEach(r=> s+=Number(r.price||0)); data.push(s); } incomeChart.data.labels = labels; incomeChart.data.datasets[0].data = data; incomeChart.update(); }

function updateStats(){ let home=0, online=0, other=0, modem=0, total=0; for(const date in tasks){ for(const r of tasks[date]){ total++; const t = r.addrType || 'other'; if(t==='home') home++; else if(t==='online') online++; else other++; if(r.modemSold) modem++; } } statsChart.data.datasets[0].data = [home, online, other]; statsChart.update(); modemCounterEl.textContent = `${modem}/${total}`; const tot = Math.max(1, home+online+other); addrPercents.textContent = `–î–æ–º: ${Math.round(home/tot*100)}% ‚Ä¢ –û–Ω–ª–∞–π–Ω: ${Math.round(online/tot*100)}% ‚Ä¢ –î—Ä—É–≥–æ–µ: ${Math.round(other/tot*100)}%`; }

// --- ensure tasksList scroll area size fits screen ---
function adjustTasksHeight(){ try{ const rect = tasksList.getBoundingClientRect(); const viewport = window.innerHeight; const spaceBelow = 20; const maxH = Math.max(120, viewport - rect.top - spaceBelow); tasksList.style.maxHeight = maxH + 'px'; }catch(e){} }
window.addEventListener('resize', adjustTasksHeight);

// --- Init & expose ---
init();
window._mobileTasks = tasks;
</script>
</body>
</html>
